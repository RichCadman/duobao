var channelLog = { domain: "bglog.bitauto.com", apidomain: "api.cheyisou.com", bglogId: "", DC: null, imageUrl: "", Init: function (d, a) { this.imageUrl = "http://" + this.domain + "/postlog.gif?"; var c = this.Methods.Cookie.getCookie("UserGuid"); var b = this; if (c.length > 0) { b.InitUrl(d, a) } else { this.Methods.GetbglogId().done(function () { b.InitUrl(d, a) }) } }, InitUrl: function (f, b) { var a = this.imageUrl; try { this.DC = this.Methods.DCInit(); this.bglogId = this.Methods.Cookie.getCookie("UserGuid"); for (var d in this.DC) { if (this.DC[d]) { a += "&" + d + "=" + this.Methods.Escape(this.DC[d], this.Methods.RE) } } a += "&b=" + this.bglogId; if (typeof (f) != "undefined" && typeof (b) != "undefined") { if (f && b) { a += "&u=" + f + "," + b } } this.imageUrl = a } catch (c) { } }, SendLog: function (d, j, h) { if (this.imageUrl == "") { Bglog_InitPostLogUrl() } var c = $(j); var a = this.imageUrl; try { if (typeof (ChannelLOGCollector) != "undefined") { for (var b in ChannelLOGCollector) { if (ChannelLOGCollector[b]) { a += "&" + b + "=" + this.Methods.Escape(ChannelLOGCollector[b], this.Methods.RE) } } } if (typeof (d) != "undefined") { a += "&channel=" + d } a += "&linkurl=" + c.attr("href"); if (a.length > 2048 && navigator.userAgent.indexOf("MSIE") >= 0) { a = a.substring(0, 2042) + "&sub=1" } if (c.attr("cysRecommend") == "1") { (new Image()).src = channelLog.imageUrl.replace("/postlog.gif?", "/recommend.gif?") + "&logtype=1&rid=" + c.attr("DataRid") + "&channelcode=" + d + "&position=" + c.attr("DataPosition") + "&engine=" + c.attr("DataEngine") + "&score=" + c.attr("DataScore") + "&datatype=" + c.attr("DataType") + "&logts=" + (new Date()).getTime(); (new Image()).src = "http://" + this.apidomain + "/Recommend/RecomClickLog.aspx?ukey=" + this.bglogId + "&rid=" + c.attr("DataRid") + "&ub=" + d + "&up=" + c.attr("DataPosition") + "&en=" + c.attr("DataEngine") + "&sc=" + c.attr("DataScore") + "&dt=" + c.attr("DataType") + "&logts=" + (new Date()).getTime() } else { (new Image()).src = a + "&logts=" + (new Date()).getTime() } } catch (f) { } }, Methods: { DCInit: function () { var a = new Object(); var c = window.document.referrer; if ((c != "") && (c != "-")) { a.ref = this.Encode(c) } var b = document.URL || window.document.URL; a.url = this.Encode(b); a.brw = navigator.userAgent; a.appV = navigator.appVersion; return a }, GetbglogId: function () { var c = $.Deferred(); var a = ["api.i.yiche.com", "api.i.bitauto.com", "api.i.cheyisou.com"]; var f = document.domain.split(".").slice(-2).join("."); function d() { for (var g = 0; g < a.length; g++) { if (a[g].indexOf(f) > -1) { a.splice(g, 1); break } } } function e() { var h = channelLog.Methods.Cookie.getCookie("UserGuid"); var g = []; $.each(a, function (j, k) { g.push($.getScript("http://" + k + "/clientApi/UserTraceCookie?key=UserGuid&val=" + h)) }); $.when(g).done(function () { c.resolve() }) } function b() { $.getScript("http://api.i." + f + "/clientApi/UserTraceCookie").done(e) } d(); b(); setTimeout(function () { c.reject() }, 3000); return c.promise() }, RE: { "%09": /\t/g, "%20": / /g, "%23": /\#/g, "%26": /\&/g, "%2B": /\+/g, "%3F": /\?/g, "%5C": /\\/g, "%22": /\"/g, "%7F": /\x7F/g, "%A0": /\xA0/g }, Encode: function (a) { return (typeof (encodeURIComponent) == "function") ? encodeURIComponent(a) : escape(a) }, Escape: function (b, a) { if (window.RegExp && typeof (a) != "undefined") { var d = new String(b); for (var c in a) { d = d.replace(a[c], c) } return d } else { return escape(b) } }, guidGenerator: function () { var b = function () { return (((1 + Math.random()) * 65536) | 0).toString(16).substring(1) }; return (b() + b() + "-" + b() + "-" + b() + "-" + b() + "-" + b() + b() + b()) }, Cookie: { setCookie: function (b, g, f, i, a) { var d = b + "=" + encodeURIComponent(g); if (typeof (f) !== "undefined" && !!f) { var c = new Date(); var h = f * 3600 * 1000; c.setTime(c.getTime() + h); d += "; expires=" + c.toGMTString() } (!i && (i = "/")); (!a && (a = document.domain)); d += ";path=" + i + ";domain=" + a; document.cookie = d }, getCookie: function (b) { var a = document.cookie.match(new RegExp("(^| )" + b + "=([^;]*)(;|$)")); if (a != null) { return unescape(a[2]) } return "" }, clearCookie: function (b, c, a) { if (this.getCookie(b)) { document.cookie = b + "=" + ((c) ? "; path=" + c : "; path=/") + ";expires=Fri, 02-Jan-1970 00:00:00 GMT" } } } } }; function Bglog_InitPostLog() { var b = (!!window.ActiveXObject || "ActiveXObject" in window) && navigator.userAgent.indexOf("MSIE") > 0 && parseInt(navigator.userAgent.match(/MSIE ([\d.]+)/)[1]) < 8; var a = function (o, j) { var m = $(o); var i = m.attr("data_cyslogclickflag"); if (i && i.split(",").indexOf(j) > -1) { return true } if (i) { m.attr("data_cyslogclickflag", i + "," + j) } else { m.attr("data_cyslogclickflag", j) } if (m.attr("cysRecommend") == "1") { if (channelLog.imageUrl == "") { Bglog_InitPostLogUrl() } (new Image()).src = channelLog.imageUrl.replace("/postlog.gif?", "/recommend.gif?") + "&logtype=0&rid=" + m.attr("DataRid") + "&channelcode=" + j + "&position=" + m.attr("DataPosition") + "&engine=" + m.attr("DataEngine") + "&score=" + m.attr("DataScore") + "&datatype=" + m.attr("DataType") + "&logts=" + (new Date()).getTime() } var l = jQuery.fn.jquery.split("."); if (b || parseInt(l[0] + l[1]) < 18) { m.click(function () { BglogPostLog(j, this) }) } else { if (m.attr("onclick") != null && typeof (m.attr("onclick")) != "undefined") { var n = m.attr("onclick"); m.attr("onclick", "BglogPostLog('" + j + "',this);" + n) } else { m.attr("onclick", "BglogPostLog('" + j + "',this);") } } return true }; var k = $("[data-channelid]"); for (var f = 0; f < k.length; f++) { var g = $(k[f]); var c = g.attr("data-channelid"); if (g[0].tagName.toLowerCase() === "a") { a(g, c) } else { var d = g.find("a"); var h = d.length; if (h > 0) { for (var e = 0; e < h; e++) { a($(d[e]), c) } } else { a(g, c) } } } } function Bglog_InitPostLogUrl() { if (typeof (Bitauto) != "undefined" && !!Bitauto && typeof (Bitauto.Login) != "undefined" && !!Bitauto.Login) { Bitauto.Login.onComplatedHandlers.add("memory once", function (a) { if (a.isLogined) { channelLog.Init(a.userId, a.userName) } else { channelLog.Init() } }) } else { channelLog.Init() } } function BglogPostLog(a, c, b) { if (typeof (a) == "undefined" || a == "") { return } channelLog.SendLog(a, c, b) } (function () { Bglog_InitPostLogUrl(); var a = window.onload; if (typeof window.onload != "function") { window.onload = Bglog_InitPostLog } else { window.onload = function () { a(); Bglog_InitPostLog() } } })();